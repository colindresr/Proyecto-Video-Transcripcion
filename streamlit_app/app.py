# app.py
import os  # Importa el m√≥dulo os para interactuar con el sistema operativo.
import streamlit as st  # Importa Streamlit para crear la interfaz web interactiva.
import sys  # Importa sys para manipular el sistema y sus par√°metros.
import requests  # Importa requests para realizar solicitudes HTTP.
# Agrega el directorio ra√≠z (el que contiene procesador.py) al path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from procesador import buscar_en_internet # Importa la funci√≥n buscar_en_internet desde procesador.py

# URL base de la API de Django, obtenida desde las variables de entorno o con un valor predeterminado.
DJANGO_API_URL = os.getenv("DJANGO_API_URL", "http://localhost:10000")
print(f"Usando DJANGO_API_URL: {DJANGO_API_URL}")

# ===== Cargar estilos =====
def cargar_css(ruta):
    """
    Carga un archivo CSS y lo aplica a la aplicaci√≥n Streamlit.

    Args:
        ruta (str): Ruta del archivo CSS.
    """
    with open(ruta) as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# Ruta del archivo CSS en el mismo directorio que este script.
css_path = os.path.join(os.path.dirname(__file__), "styles.css")
cargar_css(css_path)

# ===== Navbar =====
# Crea un men√∫ de navegaci√≥n en la barra lateral.
st.sidebar.markdown('<h2 class="stTitle">üìö Navegaci√≥n</h2>', unsafe_allow_html=True)
pagina = st.sidebar.radio("Ir a:", ["Inicio", "Chat"])

# ===== Inicio =====
if pagina == "Inicio":
    # Muestra el t√≠tulo y descripci√≥n principal de la aplicaci√≥n.
    st.markdown('<h1 class="titulo-app">Bienvenido al Asistente de Video</h1>', unsafe_allow_html=True)
    st.markdown('<div class="texto-grande">Utiliza el men√∫ lateral para comenzar a transcribir y hacer preguntas sobre videos.</div>', unsafe_allow_html=True)

    # Muestra informaci√≥n sobre las funcionalidades de la aplicaci√≥n.
    st.markdown("""
    <div class="texto-grande">
        Este proyecto es una herramienta interactiva que te permite transcribir videos de plataformas como YouTube
        e interactuar con su contenido mediante preguntas en lenguaje natural.
        <br><br>
        üîç <strong>¬øQu√© puedes hacer con esta app?</strong>
        <ul>
            <li>üìπ Ingresar el enlace de un video y obtener su transcripci√≥n completa.</li>
            <li>üìÅ Subir un archivo .txt con m√∫ltiples enlaces y procesarlos en lote.</li>
            <li>üìÑ Descargar la transcripci√≥n en formato PDF.</li>
            <li>üí¨ Hacer preguntas sobre el contenido del video y obtener respuestas inteligentes.</li>
        </ul>
        <br>
        Utiliza el men√∫ lateral para comenzar. ¬°Explora y saca el m√°ximo provecho a tus videos!
        <br><br>
        üîß  <strong>Tecnolog√≠as utilizadas en este proyecto:</strong>
        <ul>
            <li><strong>Streamlit</strong> para la interfaz web interactiva.</li>
            <li><strong>Django</strong> con Django REST Framework para el backend y API.</li>
            <li><strong>Python</strong> como lenguaje de programaci√≥n principal.</li>
            <li><strong>ffmpeg</strong> para procesar videos y extraer audio.</li>
            <li><strong>MongoDB</strong> para almacenar transcripciones y otros datos.</li>
            <li><strong>Requests</strong> para la interacci√≥n con la API.</li>
        </ul>
    </div>
    """, unsafe_allow_html=True)

    # Muestra un cuadro de advertencia con informaci√≥n importante sobre la aplicaci√≥n.
    st.markdown("""
    <div class="disclaimer-box">
        ‚ö†Ô∏è <strong>Importante:</strong> Esta aplicaci√≥n utiliza una <strong>API interna</strong> para procesar y transcribir videos, as√≠ como para responder preguntas mediante inteligencia artificial.
        <br><br>
        üì° Las peticiones realizadas desde esta interfaz se comunican con un servidor backend local o desplegado, el cual se encarga del procesamiento del audio, la transcripci√≥n, la generaci√≥n del PDF y la interacci√≥n con modelos de lenguaje.
        <br><br>
        üõ°Ô∏è <strong>Privacidad:</strong> No se almacena informaci√≥n sensible del usuario. Las transcripciones y PDFs generados se guardan √∫nicamente con fines de visualizaci√≥n y consulta dentro de la sesi√≥n.
        <br><br>
        üß™ Esta herramienta es experimental y se encuentra en desarrollo. Puede haber errores o limitaciones en los resultados.
    </div>
    """, unsafe_allow_html=True)

# ===== Chat =====
elif pagina == "Chat":
    # Muestra el t√≠tulo de la secci√≥n de chat.
    st.markdown('<h1 class="titulo-app">Asistente de Video</h1>', unsafe_allow_html=True)

    # Secci√≥n para ingresar un enlace de video.
    st.markdown('<div class="header-custom">üîó Ingresar link directamente</div>', unsafe_allow_html=True)
    link = st.text_input("Pega el link del video aqu√≠")

    # Bot√≥n para transcribir el video.
    if st.button("Transcribir video"):
        if link:
            with st.spinner("Procesando video..."):
                # Env√≠a una solicitud POST a la API para procesar el video.
                res = requests.post(f"{DJANGO_API_URL}/api/procesar/", json={"link": link})

                if res.status_code == 200:
                    try:
                        data = res.json()
                        if "transcripcion" in data and "titulo" in data and "id" in data:
                            # Guarda los datos de la transcripci√≥n en el estado de la sesi√≥n.
                            st.session_state["transcripcion"] = data["transcripcion"]
                            st.session_state["titulo"] = data["titulo"]
                            st.session_state["id"] = data["id"]
                            st.success(f"‚úÖ {data['titulo']} transcrito con √©xito")

                            # Muestra un enlace para descargar el PDF.
                            pdf_id = data.get("id")
                            st.markdown(
                                f'<div class="link-limpio"><a href="{DJANGO_API_URL}/api/descargar_pdf/?id={pdf_id}" target="_blank">üì• Descargar PDF desde servidor</a></div>',
                                unsafe_allow_html=True
                            )
                        else:
                            st.error("‚ùå La respuesta no contiene la transcripci√≥n esperada.")
                            st.json(data)
                    except Exception as e:
                        st.error(f"‚ùå Error interpretando la respuesta del servidor: {e}")
                        st.write(res.text)
                else:
                    st.error(f"‚ùå Error procesando el video. C√≥digo: {res.status_code}")
                    try:
                        st.json(res.json())
                    except:
                        st.write(res.text)

    # Secci√≥n para subir un archivo .txt con enlaces de videos.
    st.divider()
    st.markdown('<div class="header-custom">üìÑ Subir archivo .txt con links</div>', unsafe_allow_html=True)
    archivo = st.file_uploader("Selecciona un archivo .txt", type=["txt"])

    if archivo is not None:
        # Lee el contenido del archivo y procesa cada enlace.
        contenido = archivo.read().decode("utf-8")
        links = [line.strip() for line in contenido.splitlines() if line.strip()]
        if st.button("Procesar archivo"):
            resultados = []
            for i, url in enumerate(links):
                with st.spinner(f"Procesando {url}..."):
                    res = requests.post(f"{DJANGO_API_URL}/api/procesar/", json={"link": url})
                    if res.status_code == 200:
                        try:
                            data = res.json()
                            resultados.append(data)
                            st.success(f"{i+1}. ‚úÖ {data.get('titulo', 'Sin t√≠tulo')}")
                        except:
                            st.error(f"{i+1}. ‚ùå Error al interpretar respuesta para: {url}")
                    else:
                        st.error(f"{i+1}. ‚ùå Error al procesar: {url}")
            st.session_state["batch_resultados"] = resultados

    # Muestra la transcripci√≥n si est√° disponible en el estado de la sesi√≥n.
    st.divider()
    if "transcripcion" in st.session_state:
        st.markdown('<div class="subheader-custom">üìù Transcripci√≥n:</div>', unsafe_allow_html=True)
        st.text_area("Texto", value=st.session_state["transcripcion"], height=300)

        # Secci√≥n para hacer preguntas sobre la transcripci√≥n.
        pregunta = st.text_input("‚ùì Haz una pregunta sobre el video")
        if st.button("Preguntar") and pregunta:
            with st.spinner("Buscando respuesta..."):
                res = requests.post(f"{DJANGO_API_URL}/api/preguntar/", json={
                    "pregunta": pregunta,
                    "contenido": st.session_state["transcripcion"]
                })
                if res.status_code == 200:
                    respuesta = res.json().get("respuesta", "Sin respuesta")
                    st.markdown('<div class="subheader-custom">üí¨ Respuesta:</div>', unsafe_allow_html=True)
                    st.write(respuesta)
                else:
                    st.error("‚ùå Error al enviar la pregunta")

# Muestra los resultados del procesamiento por lotes si est√°n disponibles.
if "batch_resultados" in st.session_state:
    st.markdown('<div class="subheader-custom">üì¶ Resultados del archivo:</div>', unsafe_allow_html=True)
    for i, item in enumerate(st.session_state["batch_resultados"]):  # Usa enumerate para obtener un √≠ndice
        st.markdown(f"<div class='texto-grande'><strong>{item.get('titulo', 'Sin t√≠tulo')}</strong></div>", unsafe_allow_html=True)
        st.text_area("Transcripci√≥n", value=item.get("transcripcion", ""), height=200, key=f"transcripcion_{item.get('id', '')}")
        if 'id' in item:
            st.markdown(
                f'<div class="link-limpio"><a href="{DJANGO_API_URL}/api/descargar_pdf/?id={item["id"]}" target="_blank">üì• Descargar PDF desde servidor</a></div>',
                unsafe_allow_html=True
            )
        with st.form(key=f"form_{item.get('id', i)}"):  # Ahora i est√° definido
            pregunta = st.text_input("‚ùì Haz una pregunta sobre este video", key=f"pregunta_{item.get('id', i)}")
            submit = st.form_submit_button("Preguntar")
            if submit and pregunta:
                with st.spinner("Buscando respuesta..."):
                    res = requests.post(f"{DJANGO_API_URL}/api/preguntar/", json={
                        "pregunta": pregunta,
                        "contenido": item.get("transcripcion", "")
                    })
                    if res.status_code == 200:
                        respuesta = res.json().get("respuesta", "Sin respuesta")
                        st.markdown("üí¨ **Respuesta:**")
                        st.write(respuesta)
                    else:
                        st.error("‚ùå Error al enviar la pregunta")
                        
# ===== Buscar en Internet (solo si hay alguna transcripci√≥n disponible) =====
if "transcripcion" in st.session_state or "batch_resultados" in st.session_state:
    st.divider()
    st.markdown('<div class="subheader-custom">üåê Buscar en Internet:</div>', unsafe_allow_html=True)

    consulta = st.text_input("üîç Escribe tu consulta para buscar en internet")
    if st.button("Buscar en Internet"):
        if consulta:
            with st.spinner("Buscando en internet..."):
                resultados = buscar_en_internet(consulta, max_resultados=5)
                if resultados:
                    st.markdown('<div class="subheader-custom">üìÑ Resultados de la b√∫squeda:</div>', unsafe_allow_html=True)
                    for resultado in resultados:
                        if "error" in resultado:
                            st.error(resultado["error"])
                        else:
                            st.markdown(f"**T√≠tulo:** {resultado['titulo']}")
                            st.markdown(f"**URL:** [Enlace]({resultado['url']})")
                            st.markdown(f"**Resumen:** {resultado['resumen']}")
                            st.markdown("---")
                else:
                    st.warning("No se encontraron resultados para la consulta.")